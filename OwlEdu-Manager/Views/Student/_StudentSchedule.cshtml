<div class="container py-4">
    <div class="btl-card">
        <div class="title row align-items-center g-2">
            <div class="col-12 col-md-8">
                <p class="m-0">Lịch học của bạn</p>
            </div>
        </div>

        <div class="col-12 col-md-6 d-flex align-items-center">
            <label for="date-picker" class="me-2 mb-0" style="width: 80px; color: var(--text-main)">Ngày học</label>
            <input type="date" id="date-picker" class="form-control"/>
        </div>

        <div class="component-container" hx-get="/Components/Schedule" hx-vals='{"Id": "schedule"}' hx-trigger="revealed" data-on-load="onLoad"></div>
        
	</div>
</div>

<script type="module">
    import ClassAssignmentService from "../../js/API/ClassAssignmentService.js";
    import AttendanceService from "../../js/API/AttendanceService.js";
    import ScheduleService from "../../js/API/ScheduleService.js";
    import {getStudentID} from "../../js/Utils/getCookies.js";

    window.onLoad = onLoad;
    window.SetSchedule = SetSchedule;

    const allSchedules = [];
    const allAttendances = [];

    const dateInput = document.getElementById('date-picker');
    dateInput.addEventListener('change', async () => {
        await SetSchedule(dateInput.value);
    });

    async function onLoad() {
        const response = await ClassAssignmentService.getAllClassAssignments(getStudentID() + " learning", -1, 10000);

        await Promise.all(response.map(async (ca) => {
            const schedules = await ScheduleService.getScheduleByClassId(ca.classId);
            allSchedules.push(...schedules);
        }));

        console.log(allSchedules[0]);


        // const response1 = await AttendanceService.getAllAttendances(getStudentID(), -1, 10000);
        // allAttendances.push(...response1.data);

        const now = new Date();

        await SetSchedule(now.getFullYear() + "-" + (now.getMonth() + 1) + "-" + now.getDate());

    }

    async function SetSchedule(date) {
        setScheduleWeek(date);
        console.log(1);

        var dayOfWeek = getWeekDates(date);
        console.log(2);

        for (var i = 0; i < 7; i++) {
            console.log(allSchedules[0].sessionDate);
            console.log(dayOfWeek[i]);
            allSchedules.filter(s => s.sessionDate == dayOfWeek[i]).forEach(schedule => {
                var attendance;
                // if (allAttendances.filter(a => a.scheduleId === schedule.id).length == 0) attendance = null;
                // else attendance = allAttendances.filter(a => a.scheduleId === schedule.id)[0];
                console.log(i, schedule.startTime, schedule.endTime, schedule.className + "(" + schedule.classId + ")", schedule.room, attendance);
                addEvent(i + 1, schedule.startTime, schedule.endTime, schedule.className + "(" + schedule.classId + ")", schedule.room, attendance); 
            });
        }
    }
</script>
