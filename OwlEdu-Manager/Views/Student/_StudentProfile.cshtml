<div class="container py-4">

    <div class="row g-4">

        <!-- LEFT: AVATAR + UPLOAD -->
        <div class="col-lg-4">
            <div class="btl-card shadow-sm">

                <h5 class="btl-card-title" style="border-bottom: 1px solid var(--border); padding-bottom: 10px; color:var(--text-main);">Ảnh đại diện</h5>

                <div class="text-center mt-3">
                    <img id="btl-avatar" src="https://i.pravatar.cc/200"
                         class="btl-avatar-preview rounded-circle" style="width:120px;height:120px;object-fit:cover;">

                    <div class="mt-2">
                        <a href="#" id="btl-delete-avatar" class="text-danger me-3">Xóa ảnh</a>
                        <a href="#" id="btl-update-avatar" class="text-primary">Cập nhật ảnh</a>
                    </div>

                    <!-- Upload area -->
                    <div id="btl-upload-area" class="btl-upload-box mt-4">
                        <i class="fa-solid fa-upload btl-upload-icon"></i>
                        <p class="m-0 fw-bold text-primary">Nhấn để tải ảnh lên</p>
                        <p class="text-muted small">hoặc kéo thả ảnh vào đây</p>
                        <p class="text-muted small">JPG hoặc PNG</p>

                        <input type="file" id="btl-file-input" class="d-none" accept="image/*">
                    </div>
                </div>

            </div>
        </div>

        <!-- RIGHT: PROFILE FORM -->
        <div class="col-lg-8">

            <!-- Section: Thông tin tài khoản -->
            <div class="btl-card shadow-sm" data-section="account">

                <div class="d-flex justify-content-between align-items-center" style="border-bottom: 1px solid var(--border); padding-bottom: 10px;">
                    <h5 class="btl-card-title" style="color:var(--text-main);">Thông tin tài khoản</h5>
                    <div>
                        <button class="btn btn-primary btn-sm btn-edit">
                            <i class="fa-solid fa-pen"></i> Chỉnh sửa
                        </button>
                        <div class="d-inline-block btn-save-cancel d-none">
                            <button class="btn btn-success btn-sm btn-save" id="btn-save-account">
                                <i class="fa-solid fa-check"></i> Lưu
                            </button>
                            <button class="btn btn-danger btn-sm btn-cancel">
                                <i class="fa-solid fa-xmark"></i> Hủy
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row mt-3 g-3">
                    <div class="col-md-6">
                        <label class="btl-label-display" style="color:var(--text-main);">Mã học viên</label>
                        <p id="id-display" class="btl-view-display">student01</p>
                    </div>

                    <div class="col-md-6">
                        <label class="btl-label" style="color:var(--text-main);">Tên tài khoản</label>
                        <p id="username-display" class="btl-view">student01</p>
                        <input id="username-input" class="form-control btl-edit d-none" value="student01">
                    </div>

                    <div class="col-md-6">
                        <label class="btl-label" style="color:var(--text-main);">Email</label>
                        <p id="email-display" class="btl-view">student@gmail.com</p>
                        <input id="email-input" type="email" class="form-control btl-edit d-none" value="student@gmail.com">
                    </div>

                    <div class="col-md-6">
                        <label class="btl-label" style="color:var(--text-main);">Mật khẩu</label>
                        <p class="btl-view">********</p>
                        <input id="password-input" type="password" class="form-control btl-edit d-none" value="">
                    </div>
                </div>

            </div>

            <!-- Section: Thông tin cá nhân -->
            <div class="btl-card shadow-sm mt-4" data-section="personal">

                <div class="d-flex justify-content-between align-items-center" style="border-bottom: 1px solid var(--border); padding-bottom: 10px;">
                    <h5 class="btl-card-title" style="color:var(--text-main);">Thông tin cá nhân</h5>
                    <div>
                        <button class="btn btn-primary btn-sm btn-edit">
                            <i class="fa-solid fa-pen"></i> Chỉnh sửa
                        </button>
                        <div class="d-inline-block btn-save-cancel d-none">
                            <button class="btn btn-success btn-sm btn-save" id="btn-save-profile">
                                <i class="fa-solid fa-check"></i> Lưu
                            </button>
                            <button class="btn btn-danger btn-sm btn-cancel">
                                <i class="fa-solid fa-xmark"></i> Hủy
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row mt-3 g-3">
                    <div class="col-md-6">
                        <label class="btl-label" style="color:var(--text-main);">Họ và tên</label>
                        <p id="fullname-display" class="btl-view">Nguyen</p>
                        <input id="fullname-input" class="form-control btl-edit d-none" value="Nguyen">
                    </div>

                    <div class="col-md-6">
                        <label class="btl-label" style="color:var(--text-main);">Ngày sinh</label>
                        <p id="birthdate-display" class="btl-view">21/01/2005</p>
                        <input id="birthdate-input" type="date" class="form-control btl-edit d-none" value="">
                    </div>

                    <div class="col-md-6">
                        <label class="btl-label" style="color:var(--text-main);">Số điện thoại</label>
                        <p id="phonenumber-display" class="btl-view">0987654321</p>
                        <input id="phonenumber-input" class="form-control btl-edit d-none" value="0987654321">
                    </div>

                    <div class="col-md-6">
                        <label class="btl-label" style="color:var(--text-main);">Giới tính</label>
                        <p id="gender-display" class="btl-view">Nam</p>
                        <select id="gender-input" class="form-control btl-edit d-none">
                            <option>Nam</option>
                            <option>Nữ</option>
                        </select>
                    </div>

                    <div class="col-md-12">
                        <label class="btl-label" style="color:var(--text-main);">Địa chỉ</label>
                        <p id="address-display" class="btl-view">ABC</p>
                        <input id="address-input" class="form-control btl-edit d-none" value="ABC">
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<style>

.btl-card {
    background: var(--surface);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--border);
}

.btl-card-title {
    font-weight: 600;
    font-size: 18px;
}

.btl-label {
    font-weight: 600;
    font-size: 14px;
}

.btl-view {
    padding: 8px 0;
    margin: 0;
    color: var(--text-muted);
}

.btl-label-display {
    font-weight: 600;
    font-size: 14px;
}

.btl-view-display {
    padding: 8px 0;
    margin: 0;
    color: var(--text-muted);
}

.btl-avatar-preview {
    width: 140px;
    height: 140px;
    border-radius: 100px;
    object-fit: cover;
}

.btl-upload-box {
    border: 2px dashed var(--border);
    padding: 25px;
    border-radius: 12px;
    cursor: pointer;
}

.btl-upload-box:hover {
    border-color: var(--primary);
    background: #4e46e547;
}

.btl-upload-icon {
    font-size: 24px;
    color: var(--primary);
}

</style>

<script type="module">
    import {getStudentID, getUserID} from "../../js/Utils/getCookies.js";
    import StudentService from "../../js/API/StudentService.js";
    import AccountService from "../../js/API/AccountService.js";

    window.SetEvents = SetEvents;
    window.Setup = Setup;

    await Setup();

    async function Setup() {
        SetEvents();

        console.log(getStudentID());
        const studentInfor = await StudentService.getStudentById(getStudentID());

        $('#fullname-display').text(studentInfor.fullName);
        $('#fullname-input').val(studentInfor.fullName);

        $('#birthdate-display').text(studentInfor.birthDate);
        $('#birthdate-input').val(studentInfor.birthDate);

        $('#phonenumber-display').text(studentInfor.phoneNumber);
        $('#phonenumber-input').val(studentInfor.phoneNumber);

        $('#gender-display').text(studentInfor.gender);
        $('#gender-input').val(studentInfor.gender);

        $('#address-display').text(studentInfor.address);
        $('#address-input').val(studentInfor.address);

        $('#id-display').text(studentInfor.id);

        $('#username-display').text(studentInfor.accountResponse.username);
        $('#username-input').val(studentInfor.accountResponse.username);

        $('#email-display').text(studentInfor.accountResponse.email);
        $('#email-input').val(studentInfor.accountResponse.email);
    }

    function SetEvents() {
        $('.btn-edit').click(function(){
            const $section = $(this).closest('[data-section]');
            $section.find('.btl-view').addClass('d-none');
            $section.find('.btl-edit').removeClass('d-none');
            $(this).addClass('d-none');
            $section.find('.btn-save-cancel').removeClass('d-none');
        });

        $('.btn-cancel').click(function(){
            const $section = $(this).closest('[data-section]');
            $section.find('.btl-edit').addClass('d-none');
            $section.find('.btl-view').removeClass('d-none');
            $section.find('.btn-save-cancel').addClass('d-none');
            $section.find('.btn-edit').removeClass('d-none');
        });

        $('btn-save').click(function(){
            const $section = $(this).closest('[data-section]');
            // Lưu dữ liệu: cập nhật view từ input
            $section.find('.btl-edit').each(function(){
                const val = $(this).val();
                $(this).siblings('.btl-view').text(val);
            });

            $section.find('.btl-edit').addClass('d-none');
            $section.find('.btl-view').removeClass('d-none');
            $section.find('.btn-save-cancel').addClass('d-none');
            $section.find('.btn-edit').removeClass('d-none');
        });

        $('#btn-save-account').click(function(){
            const $section = $(this).closest('[data-section]');
            // Lưu dữ liệu: cập nhật view từ input
            $section.find('.btl-edit').each(function(){
                const val = $(this).val();
                $(this).siblings('.btl-view').text(val);
            });

            $section.find('.btl-edit').addClass('d-none');
            $section.find('.btl-view').removeClass('d-none');
            $section.find('.btn-save-cancel').addClass('d-none');
            $section.find('.btn-edit').removeClass('d-none');

            const updateAccount = {
              username: $('#username-input').val(),
              birthDate: $('#email-input').val(),
              password: $('#password-input').val()
            }

            $('#username-display').text($('#username-input').val());

            $('#email-display').text($('#email-input').val());

            // await AccountService.updateAccount(getUserID(), updateAccount);
        });

        $('#btn-save-profile').click(async function(){

            const $section = $(this).closest('[data-section]');
            // Lưu dữ liệu: cập nhật view từ input
            $section.find('.btl-edit').each(function(){
                const val = $(this).val();
                $(this).siblings('.btl-view').text(val);
            });

            $section.find('.btl-edit').addClass('d-none');
            $section.find('.btl-view').removeClass('d-none');
            $section.find('.btn-save-cancel').addClass('d-none');
            $section.find('.btn-edit').removeClass('d-none');

            const updateProfile = {
              fullName: $('#fullname-input').val(),
              birthDate: $('#birthdate-input').val(),
              phoneNumber: $('#phonenumber-input').val(),
              gender: $('#gender-input').val(),
              address: $('#address-input').val()
            }

            $('#fullname-display').text($('#fullname-input').val());

            $('#birthdate-display').text($('#birthdate-input').val());

            $('#phonenumber-display').text($('#phonenumber-input').val());

            $('#gender-display').text($('#gender-input').val());

            $('#address-display').text($('#address-input').val());

            await StudentService.updateStudent(getStudentID(), updateProfile);
        });
    }
</script>
